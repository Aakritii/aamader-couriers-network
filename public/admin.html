<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard | Aamader Courier Networks</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
</head>

<body>

<!-- ðŸ” AUTH CHECK -->
<script>
const token = localStorage.getItem("jwt");
if (!token) {
  window.location.href = "login.html";
}
</script>

<!-- HEADER -->
<div class="topbar">
  <div class="logo" onclick="location.href='index.html'">
    Aamader Courier Networks
  </div>
  <button class="login-btn" onclick="logout()">Logout</button>
</div>

<!-- ================= ADMIN DASHBOARD ================= -->
<div class="admin-dashboard">

  <h2 style="margin-bottom:20px;">Admin Dashboard</h2>

  <!-- ADD / UPDATE TRACKING -->
  <div class="admin-add">
    <h3>Add / Update Tracking</h3>

    <input id="tracking" placeholder="Tracking Number">

    <select id="status">
      <option value="">Select Status</option>
      <option>Booked</option>
      <option>In Transit</option>
      <option>Returned</option>
      <option>Delivered</option>
    </select>

    <input type="file" id="image">
    <button onclick="save()">Save</button>
  </div>

  <!-- ================= RECORDS ================= -->
  <div class="admin-table">

    <!-- Header + Search -->
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
      <h3>All Records</h3>

      <div class="search-box">
        <input
          type="text"
          id="searchTracking"
          placeholder="Search Tracking No"
          style="padding:6px 8px;"
        >
        <button onclick="searchParcel()">Search</button>
        <button onclick="resetSearch()">Clear</button>
      </div>
    </div>

    <!-- âœ… TABLE WRAPPER (IMPORTANT FOR MOBILE) -->
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Tracking No</th>
            <th>Status</th>
            <th>Booked On</th>
            <th>Updated On</th>
            <th>Update Status</th>
            <th>Image</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="recordsTable"></tbody>
      </table>
    </div>

    <!-- PAGINATION -->
    <div class="pagination">
      <button id="prevBtn" onclick="changePage(-1)">Prev</button>
      <span id="pageInfo"></span>
      <button id="nextBtn" onclick="changePage(1)">Next</button>
    </div>

  </div>
</div>

<script>
/* ================= LOGOUT ================= */
function logout() {
  localStorage.removeItem("jwt");
  window.location.href = "login.html";
}

/* ================= SAVE ================= */
function save(trackingFromTable = null) {
  let trackingNo, statusVal, imageFile;

  if (trackingFromTable) {
    trackingNo = trackingFromTable;
    statusVal = document.getElementById(`s_${trackingNo}`).value;
    imageFile = document.getElementById(`f_${trackingNo}`)?.files[0];
  } else {
    trackingNo = document.getElementById("tracking").value.trim();
    statusVal = document.getElementById("status").value;
    imageFile = document.getElementById("image").files[0];

    if (!trackingNo || !statusVal) {
      alert("Tracking number & status required");
      return;
    }
  }

  const fd = new FormData();
  fd.append("trackingNumber", trackingNo);
  fd.append("status", statusVal);
  if (imageFile) fd.append("image", imageFile);

  fetch("/admin/add", {
    method: "POST",
    headers: { Authorization: "Bearer " + token },
    body: fd
  })
  .then(() => {
    alert("Saved successfully");
    loadRecords(currentPage);
  })
  .catch(() => alert("Save failed"));
}

/* ================= PAGINATION STATE ================= */
let currentPage = 1;
const limit = 10;
let totalPages = 1;

/* ================= LOAD RECORDS ================= */
function loadRecords(page = 1) {
  currentPage = page;

  fetch(`/admin/all?page=${page}&limit=${limit}`, {
    headers: { Authorization: "Bearer " + token }
  })
  .then(res => res.json())
  .then(res => {
    const table = document.getElementById("recordsTable");
    table.innerHTML = "";

    const records = res.data || [];
    totalPages = res.pagination?.totalPages || 1;

    if (!records.length) {
      table.innerHTML = `<tr><td colspan="7">No records found</td></tr>`;
      updatePaginationUI();
      return;
    }

    records.forEach(item => {
      table.innerHTML += `
        <tr>
          <td>${item.trackingNumber}</td>
          <td>${item.status}</td>
          <td>${formatDate(item.createdAt)}</td>
          <td>${formatDate(item.updatedAt)}</td>

          <td>
            <select id="s_${item.trackingNumber}">
              <option ${item.status==="Booked"?"selected":""}>Booked</option>
              <option ${item.status==="In Transit"?"selected":""}>In Transit</option>
              <option ${item.status==="Returned"?"selected":""}>Returned</option>
              <option ${item.status==="Delivered"?"selected":""}>Delivered</option>
            </select>
          </td>

          <td>
            ${item.image ? `
              <a href="${item.image}" target="_blank">
                <img src="${item.image}"
                     style="width:60px;height:60px;object-fit:cover;border-radius:6px;margin-bottom:6px;">
              </a>
            ` : `<span style="font-size:12px;color:#888;">No Image</span>`}
            <input type="file" id="f_${item.trackingNumber}">
          </td>

          <td>
            <button onclick="save('${item.trackingNumber}')">Save</button>
          </td>
        </tr>
      `;
    });

    updatePaginationUI();
  })
  .catch(() => alert("Failed to load records"));
}

/* ================= PAGINATION ================= */
function changePage(step) {
  const next = currentPage + step;
  if (next < 1 || next > totalPages) return;
  loadRecords(next);
}

function updatePaginationUI() {
  document.getElementById("pageInfo").innerText =
    `Page ${currentPage} of ${totalPages}`;

  document.getElementById("prevBtn").disabled = currentPage === 1;
  document.getElementById("nextBtn").disabled = currentPage === totalPages;
}

/* ================= SEARCH ================= */
function searchParcel() {
  const tn = document.getElementById("searchTracking").value.trim();
  if (!tn) return alert("Enter tracking number");

  fetch(`/track?trackingNumber=${encodeURIComponent(tn)}`)
    .then(res => res.json())
    .then(data => {
      const table = document.getElementById("recordsTable");
      table.innerHTML = "";

      if (data.error) {
        table.innerHTML = `<tr><td colspan="7">${data.error}</td></tr>`;
        document.querySelector(".pagination").style.display = "none";
        return;
      }

      table.innerHTML = `
        <tr>
          <td>${data.trackingNumber}</td>
          <td>${data.status}</td>
          <td>-</td>
          <td>${formatDate(data.updatedAt)}</td>
          <td>
            <select id="s_${tn}">
              <option ${data.status==="Booked"?"selected":""}>Booked</option>
              <option ${data.status==="In Transit"?"selected":""}>In Transit</option>
              <option ${data.status==="Returned"?"selected":""}>Returned</option>
              <option ${data.status==="Delivered"?"selected":""}>Delivered</option>
            </select>
          </td>
          <td>
            ${data.image ? `
              <a href="${data.image}" target="_blank">
                <img src="${data.image}" style="width:60px;height:60px;border-radius:6px;">
              </a>
            ` : `No Image`}
            <input type="file" id="f_${tn}">
          </td>
          <td><button onclick="save('${tn}')">Save</button></td>
        </tr>
      `;
      document.querySelector(".pagination").style.display = "none";
    });
}

/* ================= RESET SEARCH ================= */
function resetSearch() {
  document.getElementById("searchTracking").value = "";
  document.querySelector(".pagination").style.display = "flex";
  loadRecords(1);
}

/* ================= UTIL ================= */
function formatDate(dateStr) {
  if (!dateStr) return "-";
  return new Date(dateStr).toLocaleDateString("en-GB");
}

/* INIT */
loadRecords();
</script>

</body>
</html>
